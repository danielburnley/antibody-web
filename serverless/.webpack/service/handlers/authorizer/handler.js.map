{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./handlers/authorizer/handler.js"],"names":["handler","event","authorizationToken","startsWith","Error","user","decodeToken","apiOptions","tmp","methodArn","split","apiGatewayArnTmp","awsAccountId","region","restApiId","stage","policy","AuthPolicy","user_id","allowAllMethods","authResponse","build","context","token","principal","principalId","version","pathRegex","RegExp","allowMethods","denyMethods","HttpVerb","GET","POST","PUT","PATCH","HEAD","DELETE","OPTIONS","ALL","prototype","addMethod","effect","verb","resource","conditions","hasOwnProperty","test","cleanedResource","substring","length","resourceArn","toLowerCase","push","getEmptyStatement","toUpperCase","statement","Action","Effect","Resource","getStatementsForEffect","methods","statements","i","curMethod","conditionalStatement","Condition","constructor","call","denyAllMethods","allowMethod","denyMethod","allowMethodWithConditions","denyMethodWithConditions","doc","Version","Statement","concat","policyDocument"],"mappings":"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","file":"handlers/authorizer/handler.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./handlers/authorizer/handler.js\");\n","/*\n* Copyright 2015-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n*\n* Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with the License. A copy of the License is located at\n*\n*     http://aws.amazon.com/apache2.0/\n*\n* or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.\n*/\nexport async function handler(event) {\n\n  //@TODO: Implement proper token decryption\n  if (!event.authorizationToken.startsWith('TEMP_ALLOW')) {\n    throw new Error(\"Unauthorized\");\n  }\n  const user = decodeToken(event.authorizationToken);\n\n  // if the token is valid, a policy must be generated which will allow or deny access to the client\n\n  // if access is denied, the client will receive a 403 Access Denied response\n  // if access is allowed, API Gateway will proceed with the backend integration configured on the method that was called\n\n  // build apiOptions for the AuthPolicy\n  var apiOptions = {};\n  var tmp = event.methodArn.split(':');\n  var apiGatewayArnTmp = tmp[5].split('/');\n  var awsAccountId = tmp[4];\n  apiOptions.region = tmp[3];\n  apiOptions.restApiId = apiGatewayArnTmp[0];\n  apiOptions.stage = apiGatewayArnTmp[1];\n  \n  // this function must generate a policy that is associated with the recognized principal user identifier.\n  // depending on your use case, you might store policies in a DB, or generate them on the fly\n\n  // keep in mind, the policy is cached for 5 minutes by default (TTL is configurable in the authorizer)\n  // and will apply to subsequent calls to any method/resource in the RestApi\n  // made with the same token\n\n  var policy = new AuthPolicy(user.user_id, awsAccountId, apiOptions);\n  \n  // All authentication is presumably through the same endpoint, so we can allow access to all lambdas\n  policy.allowAllMethods();\n\n  // finally, build the policy\n  var authResponse = policy.build();\n\n  // new! -- add additional key-value pairs\n  // these are made available by APIGW like so: $context.authorizer.<key>\n  // additional context is cached\n  authResponse.context = {\n  };\n\n  return authResponse;\n};\n\nfunction decodeToken(token) {\n  //@TODO: Assuming they do use a JWT approach we will need WS2's secret key here.\n  // For now just pull the id out of their auth token\n  return {\n    user_id: token.split(\"TEMP_ALLOW_\")[1]\n  };\n}\n\n/**\n * AuthPolicy receives a set of allowed and denied methods and generates a valid\n * AWS policy for the API Gateway authorizer. The constructor receives the calling\n * user principal, the AWS account ID of the API owner, and an apiOptions object.\n * The apiOptions can contain an API Gateway RestApi Id, a region for the RestApi, and a\n * stage that calls should be allowed/denied for. For example\n * {\n *   restApiId: \"xxxxxxxxxx\",\n *   region: \"us-east-1\",\n *   stage: \"dev\"\n * }\n *\n * var testPolicy = new AuthPolicy(\"[principal user identifier]\", \"[AWS account id]\", apiOptions);\n * testPolicy.allowMethod(AuthPolicy.HttpVerb.GET, \"/users/username\");\n * testPolicy.denyMethod(AuthPolicy.HttpVerb.POST, \"/pets\");\n * context.succeed(testPolicy.build());\n *\n * @class AuthPolicy\n * @constructor\n */\nfunction AuthPolicy(principal, awsAccountId, apiOptions) {\n  /**\n     * The AWS account id the policy will be generated for. This is used to create\n     * the method ARNs.\n     *\n     * @property awsAccountId\n     * @type {String}\n     */\n  this.awsAccountId = awsAccountId;\n\n  /**\n     * The principal used for the policy, this should be a unique identifier for\n     * the end user.\n     *\n     * @property principalId\n     * @type {String}\n     */\n  this.principalId = principal;\n\n  /**\n     * The policy version used for the evaluation. This should always be \"2012-10-17\"\n     *\n     * @property version\n     * @type {String}\n     * @default \"2012-10-17\"\n     */\n  this.version = \"2012-10-17\";\n\n  /**\n     * The regular expression used to validate resource paths for the policy\n     *\n     * @property pathRegex\n     * @type {RegExp}\n     * @default '^\\/[/.a-zA-Z0-9-\\*]+$'\n     */\n  this.pathRegex = new RegExp('^[/.a-zA-Z0-9-\\*]+$');\n\n  // these are the internal lists of allowed and denied methods. These are lists\n  // of objects and each object has 2 properties: A resource ARN and a nullable\n  // conditions statement.\n  // the build method processes these lists and generates the approriate\n  // statements for the final policy\n  this.allowMethods = [];\n  this.denyMethods = [];\n\n  if (!apiOptions || !apiOptions.restApiId) {\n    this.restApiId = \"*\";\n  } else {\n    this.restApiId = apiOptions.restApiId;\n  }\n  if (!apiOptions || !apiOptions.region) {\n    this.region = \"*\";\n  } else {\n    this.region = apiOptions.region;\n  }\n  if (!apiOptions || !apiOptions.stage) {\n    this.stage = \"*\";\n  } else {\n    this.stage = apiOptions.stage;\n  }\n};\n\n/**\n * A set of existing HTTP verbs supported by API Gateway. This property is here\n * only to avoid spelling mistakes in the policy.\n *\n * @property HttpVerb\n * @type {Object}\n */\nAuthPolicy.HttpVerb = {\n  GET     : \"GET\",\n  POST    : \"POST\",\n  PUT     : \"PUT\",\n  PATCH   : \"PATCH\",\n  HEAD    : \"HEAD\",\n  DELETE  : \"DELETE\",\n  OPTIONS : \"OPTIONS\",\n  ALL     : \"*\"\n};\n\nAuthPolicy.prototype = (function() {\n  /**\n   * Adds a method to the internal lists of allowed or denied methods. Each object in\n   * the internal list contains a resource ARN and a condition statement. The condition\n   * statement can be null.\n   *\n   * @method addMethod\n   * @param {String} The effect for the policy. This can only be \"Allow\" or \"Deny\".\n   * @param {String} he HTTP verb for the method, this should ideally come from the\n   *                 AuthPolicy.HttpVerb object to avoid spelling mistakes\n   * @param {String} The resource path. For example \"/pets\"\n   * @param {Object} The conditions object in the format specified by the AWS docs.\n   * @return {void}\n   */\n  var addMethod = function(effect, verb, resource, conditions) {\n    if (verb !== \"*\" && !AuthPolicy.HttpVerb.hasOwnProperty(verb)) {\n      throw new Error(\"Invalid HTTP verb \" + verb + \". Allowed verbs in AuthPolicy.HttpVerb\");\n    }\n\n    if (!this.pathRegex.test(resource)) {\n      throw new Error(\"Invalid resource path: \" + resource + \". Path should match \" + this.pathRegex);\n    }\n\n    var cleanedResource = resource;\n    if (resource.substring(0, 1) === \"/\") {\n      cleanedResource = resource.substring(1, resource.length);\n    }\n    var resourceArn = \"arn:aws:execute-api:\" +\n      this.region + \":\" +\n      this.awsAccountId + \":\" +\n      this.restApiId + \"/\" +\n      this.stage + \"/\" +\n      verb + \"/\" +\n      cleanedResource;\n\n    if (effect.toLowerCase() === \"allow\") {\n      this.allowMethods.push({\n        resourceArn: resourceArn,\n        conditions: conditions\n      });\n    } else if (effect.toLowerCase() === \"deny\") {\n      this.denyMethods.push({\n        resourceArn: resourceArn,\n        conditions: conditions\n      });\n    }\n  };\n\n  /**\n   * Returns an empty statement object prepopulated with the correct action and the\n   * desired effect.\n   *\n   * @method getEmptyStatement\n   * @param {String} The effect of the statement, this can be \"Allow\" or \"Deny\"\n   * @return {Object} An empty statement object with the Action, Effect, and Resource\n   *                  properties prepopulated.\n   */\n  var getEmptyStatement = function(effect) {\n    effect = effect.substring(0, 1).toUpperCase() + effect.substring(1, effect.length).toLowerCase();\n    var statement = {};\n    statement.Action = \"execute-api:Invoke\";\n    statement.Effect = effect;\n    statement.Resource = [];\n\n    return statement;\n  };\n\n  /**\n   * This function loops over an array of objects containing a resourceArn and\n   * conditions statement and generates the array of statements for the policy.\n   *\n   * @method getStatementsForEffect\n   * @param {String} The desired effect. This can be \"Allow\" or \"Deny\"\n   * @param {Array} An array of method objects containing the ARN of the resource\n   *                and the conditions for the policy\n   * @return {Array} an array of formatted statements for the policy.\n   */\n  var getStatementsForEffect = function(effect, methods) {\n    var statements = [];\n\n    if (methods.length > 0) {\n      var statement = getEmptyStatement(effect);\n\n      for (var i = 0; i < methods.length; i++) {\n        var curMethod = methods[i];\n        if (curMethod.conditions === null || curMethod.conditions.length === 0) {\n          statement.Resource.push(curMethod.resourceArn);\n        } else {\n          var conditionalStatement = getEmptyStatement(effect);\n          conditionalStatement.Resource.push(curMethod.resourceArn);\n          conditionalStatement.Condition = curMethod.conditions;\n          statements.push(conditionalStatement);\n        }\n      }\n\n      if (statement.Resource !== null && statement.Resource.length > 0) {\n        statements.push(statement);\n      }\n    }\n\n    return statements;\n  };\n\n  return {\n    constructor: AuthPolicy,\n\n    /**\n     * Adds an allow \"*\" statement to the policy.\n     *\n     * @method allowAllMethods\n     */\n    allowAllMethods: function() {\n      addMethod.call(this, \"allow\", \"*\", \"*\", null);\n    },\n\n    /**\n     * Adds a deny \"*\" statement to the policy.\n     *\n     * @method denyAllMethods\n     */\n    denyAllMethods: function() {\n      addMethod.call(this, \"deny\", \"*\", \"*\", null);\n    },\n\n    /**\n     * Adds an API Gateway method (Http verb + Resource path) to the list of allowed\n     * methods for the policy\n     *\n     * @method allowMethod\n     * @param {String} The HTTP verb for the method, this should ideally come from the\n     *                 AuthPolicy.HttpVerb object to avoid spelling mistakes\n     * @param {string} The resource path. For example \"/pets\"\n     * @return {void}\n     */\n    allowMethod: function(verb, resource) {\n      addMethod.call(this, \"allow\", verb, resource, null);\n    },\n\n    /**\n     * Adds an API Gateway method (Http verb + Resource path) to the list of denied\n     * methods for the policy\n     *\n     * @method denyMethod\n     * @param {String} The HTTP verb for the method, this should ideally come from the\n     *                 AuthPolicy.HttpVerb object to avoid spelling mistakes\n     * @param {string} The resource path. For example \"/pets\"\n     * @return {void}\n     */\n    denyMethod : function(verb, resource) {\n      addMethod.call(this, \"deny\", verb, resource, null);\n    },\n\n    /**\n     * Adds an API Gateway method (Http verb + Resource path) to the list of allowed\n     * methods and includes a condition for the policy statement. More on AWS policy\n     * conditions here: http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Condition\n     *\n     * @method allowMethodWithConditions\n     * @param {String} The HTTP verb for the method, this should ideally come from the\n     *                 AuthPolicy.HttpVerb object to avoid spelling mistakes\n     * @param {string} The resource path. For example \"/pets\"\n     * @param {Object} The conditions object in the format specified by the AWS docs\n     * @return {void}\n     */\n    allowMethodWithConditions: function(verb, resource, conditions) {\n      addMethod.call(this, \"allow\", verb, resource, conditions);\n    },\n\n    /**\n     * Adds an API Gateway method (Http verb + Resource path) to the list of denied\n     * methods and includes a condition for the policy statement. More on AWS policy\n     * conditions here: http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Condition\n     *\n     * @method denyMethodWithConditions\n     * @param {String} The HTTP verb for the method, this should ideally come from the\n     *                 AuthPolicy.HttpVerb object to avoid spelling mistakes\n     * @param {string} The resource path. For example \"/pets\"\n     * @param {Object} The conditions object in the format specified by the AWS docs\n     * @return {void}\n     */\n    denyMethodWithConditions : function(verb, resource, conditions) {\n      addMethod.call(this, \"deny\", verb, resource, conditions);\n    },\n\n    /**\n     * Generates the policy document based on the internal lists of allowed and denied\n     * conditions. This will generate a policy with two main statements for the effect:\n     * one statement for Allow and one statement for Deny.\n     * Methods that includes conditions will have their own statement in the policy.\n     *\n     * @method build\n     * @return {Object} The policy object that can be serialized to JSON.\n     */\n    build: function() {\n      if ((!this.allowMethods || this.allowMethods.length === 0) &&\n          (!this.denyMethods || this.denyMethods.length === 0)) {\n        throw new Error(\"No statements defined for the policy\");\n      }\n\n      var policy = {};\n      policy.principalId = this.principalId;\n      var doc = {};\n      doc.Version = this.version;\n      doc.Statement = [];\n\n      doc.Statement = doc.Statement.concat(getStatementsForEffect.call(this, \"Allow\", this.allowMethods));\n      doc.Statement = doc.Statement.concat(getStatementsForEffect.call(this, \"Deny\", this.denyMethods));\n\n      policy.policyDocument = doc;\n\n      return policy;\n    }\n  };\n})();"],"sourceRoot":""}